// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

// Looking for ways to speed up your queries, or scale easily with your serverless or edge functions?
// Try Prisma Accelerate: https://pris.ly/cli/accelerate-init

generator client {
  provider = "prisma-client-js"
  previewFeatures = ["postgresqlExtensions"]
}

datasource db {
  provider = "postgresql"
  extensions = [vector]
}

enum LoginType {
  PASSWORD @map("Password")
  GOOGLE   @map("Google")
}

enum ScrapStatus {
  BASIC    @map("basic")
  DETAILED @map("detailed")
}

enum ScrapeState {
  IDLE        @map("idle")
  IN_PROGRESS @map("in_progress")
  FAILED      @map("failed")
}

enum CrawlStatus {
  IDLE        @map("idle")
  IN_PROGRESS @map("in_progress")
  COMPLETED   @map("completed")
  FAILED      @map("failed")
}

model User {
  id String @id @default(uuid())

  email    String @unique
  username String @unique

  passwordHash String?
  loginType    LoginType @default(PASSWORD)
  firstName    String
  lastName     String

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  styleProfile  UserStyleProfile?
  collections   Collection[]
  savedProducts SavedProduct[]
  feedbacks     Feedback[]
  otps          Otp[]

  phone        String?
  bio          String?
  profileImage String? @map("profile_image")

  isDeleted Boolean @default(false) @map("is_deleted")

  logs UserLog[]
}

model UserLog {
  id        String   @id @default(uuid())
  userId    String   @map("user_id")
  action    String
  ipAddress String?  @map("ip_address")
  details   Json?
  createdAt DateTime @default(now()) @map("created_at")

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@map("user_logs")
}

model UserStyleProfile {
  userId String @id @map("user_id")
  user   User   @relation(fields: [userId], references: [id])

  genderPreference  String?  @map("gender_preference") // 'men', 'women', 'both'
  styleVibe         String[] @map("style_vibe") // ["casual","streetWear"]
  favoriteColorsHex String[] @map("favorite_colors_hex") // ["#ff3b3b", "#000000"]

  topSize    Json? @map("top_size")
  bottomSize Json? @map("bottom_size")
  shoeSize   Json? @map("shoe_size")

  favoriteBrands String[] @map("favorite_brands")

  updatedAt DateTime @default(now()) @updatedAt @map("updated_at")

  @@map("user_style_profiles")
}

model Product {
  id           String                       @id @default(uuid()) @db.Uuid
  title        String
  description  String?
  brand        String?
  category     String?
  color        String[] // ["red", "maroon"]
  size         String[] // ["S", "M", "L"]
  styleTags    String[]                     @map("style_tags") // ["party", "summer", "evening"]
  material     String[] // ["cotton", "polyester"]
  fit          String[] // ["slim", "regular", "oversized"]
  gender       String? // "men", "women", "unisex"
  price        Int?
  retailer     String?
  productUrl   String?                      @unique @map("product_url")
  images       String[] // array of URLs
  inStock      Boolean                      @default(true) @map("in_stock")
  scrapStatus  ScrapStatus                  @default(BASIC) @map("scrap_status")
  scrapeState  ScrapeState                  @default(IDLE) @map("scrape_state")
  lastScraped  DateTime?                    @map("last_scraped")
  lastDetailedScrapedAt DateTime?           @map("last_detailed_scraped_at")
  lastScrapeAttemptAt   DateTime?           @map("last_scrape_attempt_at")
  popularity   Float?                       @default(0)
  rating       Float?                       @default(0)
  embedding    Unsupported("vector(768)")?
  tsv          Unsupported("tsvector")?
  createdAt    DateTime                     @default(now()) @map("created_at")
  updatedAt    DateTime                     @updatedAt @map("updated_at")
  savedIn      SavedProduct[]
  queries      ProductQuery[]

  @@index([category])
  @@index([brand])
  @@index([retailer])
  @@index([price])
  @@index([inStock])
  @@index([scrapStatus])
  @@index([gender])
  @@index([category, gender])
  @@map("products")
}

model Chat {
  id        String   @id @default(uuid()) @db.Uuid
  userId    String?  @map("user_id") @db.Uuid
  title     String?
  createdAt DateTime @default(now()) @map("created_at")

  messages Message[]
  state    ChatState?
  cursors  ChatCursor[]

  @@map("chats")
}

enum MessageRole {
  USER      @map("user")
  ASSISTANT @map("assistant")
  SYSTEM    @map("system")
}

model Message {
  id        String      @id @default(uuid()) @db.Uuid
  chatId    String      @map("chat_id") @db.Uuid
  role      MessageRole
  content   String
  createdAt DateTime    @default(now()) @map("created_at")

  chat Chat @relation(fields: [chatId], references: [id], onDelete: Cascade)

  @@map("messages")
}

model ChatState {
  chatId          String                       @id @map("chat_id") @db.Uuid
  currentQuery    String?                      @map("current_query")
  filters         Json?
  intentConfidence Json?                       @map("intent_confidence")
  mode            String?                      @default("SEARCH")
  lastCursorScore Float?                       @map("last_cursor_score")
  lastEmbedding   Unsupported("vector(768)")? @map("last_embedding")

  chat Chat @relation(fields: [chatId], references: [id], onDelete: Cascade)

  @@map("chat_state")
}

model Collection {
  id          String   @id @default(uuid()) @db.Uuid
  userId      String   @map("user_id")
  name        String
  description String?
  createdAt   DateTime @default(now()) @map("created_at")

  user          User           @relation(fields: [userId], references: [id])
  savedProducts SavedProduct[]

  @@index([userId])
  @@map("collections")
}

model SavedProduct {
  userId       String   @map("user_id")
  productId    String   @map("product_id") @db.Uuid
  collectionId String   @map("collection_id") @db.Uuid
  savedAt      DateTime @default(now()) @map("saved_at")

  user       User       @relation(fields: [userId], references: [id])
  product    Product    @relation(fields: [productId], references: [id])
  collection Collection @relation(fields: [collectionId], references: [id], onDelete: Cascade)

  @@id([userId, productId, collectionId])
  @@index([collectionId])
  @@index([savedAt])
  @@map("saved_products")
}

model Feedback {
  id        String   @id @default(uuid()) @db.Uuid
  userId    String?  @map("user_id")
  rating    Int
  topic     String
  details   String?
  createdAt DateTime @default(now()) @map("created_at")

  user User? @relation(fields: [userId], references: [id])

  @@map("feedbacks")
}

enum OtpType {
  RESET_PASSWORD
}

model Otp {
  id        String   @id @default(uuid())
  userId    String   @map("user_id")
  hash      String
  type      OtpType
  expiresAt DateTime @map("expires_at")
  createdAt DateTime @default(now()) @map("created_at")

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@map("otps")
}

model CrawlProgress {
  id              String      @id @default(uuid()) @db.Uuid
  retailer        String
  normalizedQuery String      @map("normalized_query")
  queryHash       String      @map("query_hash")
  lastPage        Int         @default(0) @map("last_page")
  scrollOffset    Int         @default(0) @map("scroll_offset")
  cursorToken     String?     @map("cursor_token")
  status          CrawlStatus @default(IDLE)
  totalProducts   Int         @default(0) @map("total_products")
  exhausted       Boolean     @default(false)
  lastCrawledAt   DateTime?   @map("last_crawled_at")
  createdAt       DateTime    @default(now()) @map("created_at")
  updatedAt       DateTime    @updatedAt @map("updated_at")

  @@unique([retailer, queryHash])
  @@index([queryHash])
  @@map("crawl_progress")
}

model ChatCursor {
  id        String   @id @default(uuid()) @db.Uuid
  chatId    String   @map("chat_id") @db.Uuid
  queryHash String   @map("query_hash")
  retailer  String
  offset    Int      @default(0)
  updatedAt DateTime @updatedAt @map("updated_at")

  chat Chat @relation(fields: [chatId], references: [id], onDelete: Cascade)

  @@unique([chatId, queryHash, retailer])
  @@index([chatId])
  @@map("chat_cursors")
}

model ProductQuery {
  productId String   @map("product_id") @db.Uuid
  queryHash String   @map("query_hash")
  retailer  String
  pageFound Int      @default(1) @map("page_found")
  rank      Int      @default(0)
  createdAt DateTime @default(now()) @map("created_at")

  product Product @relation(fields: [productId], references: [id], onDelete: Cascade)

  @@id([productId, queryHash, retailer])
  @@index([queryHash, retailer])
  @@map("product_queries")
}
